<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Blog </title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'blog/index.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" >
    <script src="https://code.jquery.com/jquery-3.6.4.js" integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E=" crossorigin="anonymous"></script>
   
</head>
<body>
    <h1>Chat Bot</h1>
    <div>
         <div id="chatbot">
             <p class="botText"> <span>Hi There</span></p>
         </div>
         
         <div id="userInput">
              <input type="text" id="textInput" name="userMassage" placeholder="Type your message">
              <form method="">
                  <button id='send' type="button" > Send</button>
              </form>
         </div>
    </div>
        
     <script>
        function  getUserResponse(){
            var userTest=$('#textInput').val();
            var userHTML= " <p class='userText'>User : <span>"+userTest+"</span></p>";
            $('#textInput').val("");
            $("#chatbot").append(userHTML);

            $.get('/chatbot/getResponse',{userMessage:userTest}).done(function(data){
                    var buttonMaasage=""
                     if(data=="hi, there"||data=="hi,Mathew"){
                         buttonMaasage="<p class='botText'>Chatbot: <span>"+data+" are you looking for, <span/></p> <button class='massgeBtn' type='submit' >event</button><button class='massgeBtn' type='submit'>Collage info</button><button class='massgeBtn' type='submit'>Department</button>"
                         $("#chatbot").append(buttonMaasage);
                     }
                     else{
                         try{
                            div=""
                            let x= setupall(JSON.parse(data),div);
                            div="<div class='mydiv'>"+x+("</div>")
                            $("#chatbot").append(div) ;

                        }catch(err){
                                buttonMaasage="<p class='botText'>Chatbot: <span>"+data+"<span/></p>"
                                    $("#chatbot").append(buttonMaasage);
                        }

                        }   
            })
        }
        $("#send").click(function(){
            getUserResponse();
        })
        $("#textInput").keydown(function(e){
            if(e.keyCode == 13){
                getUserResponse();
              }
          });


        $("#chatbot").on("click","button.massgeBtn",function(){
            console.log("Massage btn click")
            var query=$(this).text();
            $.get('/chatbot/specialQuery',{specialQuery:query}).done(function(data){
                div=""
                    let x= setupall(JSON.parse(data),div);
                    console.log(x)
                    div="<div class='mydiv'>"+x+("</div>")
                    $("#chatbot").append(div) ;
            })
            
        })

        $("#chatbot").on("click","button.infobtn",function(){
            var topic=$(this).text();
            $.get('/chatbot/getResponse',{userMessage:topic}).done(function(data){
                div=""
                let x= setupall(JSON.parse(data),div);
                div="<div class='mydiv'>"+x+("</div>")
                $("#chatbot").append(div) ;
            })  
        })
        
      

        function handlarray(data,type){
            x=""
            if(typeof data[0]=="object"){
                  Object.keys(data[0]).forEach(function(key) {
                    x=x+"<"+type+">"+key+":"+data[0][key]+"</"+type+">"
                   // console.log('Key : ' + key + ', Value : ' + data[0][key])
                  })
            }
            else if(type=="button"){
                for(let i=0;i<data.length;i++){
                    x=x+"<button class='infobtn' type='submit' >"+data[i]+"</button>"
                }
            }
            return x
        } 

        function setupall(data,div){
            Object.keys(data).forEach(function(key) {
               // console.log('Key : ' + key + ', Value : ' + data[key])
                if(Array.isArray(data[key])){
                        div= div+handlarray(data[key],key) 
                }
                else{
                    if(key=='h1'||key=="h2"|key=="h3"||key=="p"){
                        massage="<"+key+">"+data[key]+"</"+key+">"
                        div=div+(massage)
                    }
                    else if(key=="a"){
                        massage="<a href="+data[key]+">"+data[key]+"</a>"
                        div=div+(massage)
                    }
                    else if(key=="img"){
                        massage= "<img src="+data[key]+"alt=''>"
                        div=div+(massage)
                    }  
                }
              })
              return div;
        }



        
       </script>
</body>
</html>